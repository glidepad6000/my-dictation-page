<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>英文聽寫練習</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #eee;
      font-family: monospace;
      font-size: 16px;
      height: 100vh;
      overflow: hidden;
    }

    #toolbar {
      display: flex;
      gap: 6px;
      padding: 6px;
      background: #111;
      border-bottom: 1px solid #333;
    }

    #toolbar button {
      background: #222;
      color: #eee;
      border: none;
      padding: 4px 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }

    #toolbar button:hover {
      background: #444;
    }

    #note-content {
      padding: 10px;
      height: calc(100vh - 72px);
      overflow-y: auto;
      white-space: pre-wrap;
      outline: none;
    }

    .fold-block {
      margin: 0;
      padding: 0;
      border: 1px solid #444;
      background: #111;
      border-radius: 2px;
    }

    .fold-header {
      padding: 0;
      margin: 0;
      font-size: 14px;
      line-height: 1;
      color: #ffcc00;
    }

    .fold-content {
      padding: 0;
      margin: 0;
      font-size: 14px;
      line-height: 1.2;
      color: #eee;
      white-space: pre-line;
      display: none;
    }

    .fold-block.active .fold-content {
      display: block;
    }

    .selected {
      outline: 1px solid #0ff;
    }

    #log {
      height: 24px;
      padding: 4px 10px;
      background: #111;
      font-size: 12px;
      color: #ccc;
      border-top: 1px solid #333;
    }

    ::selection {
      background: #444;
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="left-panel">
    <h2>🎬 影片區</h2>
    <div class="video-input-group">
  <input type="text" id="video-url" placeholder="貼上影片網址（YouTube / Bilibili）">
  <button id="load-video">↵</button>
</div>
<div id="video-container" style="margin-top: 10px;"></div>

  </div>
  <div class="right-panel">
    <h2>📝 聽寫區</h2>
    <div class="toolbar">
      <div class="toolbar-row">
        <button id="btn-bold" onclick="toggleFormat('bold')">粗體</button>
        <button id="btn-italic" onclick="toggleFormat('italic')">斜體</button>
        <button id="btn-underline" onclick="toggleCustomFormat('underline')">底線</button>
        <button id="btn-strike" onclick="toggleCustomFormat('strike')">刪除線</button>
        <button onclick="insertFold()">插入折疊區塊</button>
      </div>
      <div class="toolbar-row">
        <button onclick="toggleColor('red', 'rgb(255, 0, 0)')" id="btn-red">🔴</button>
        <button onclick="toggleColor('pink', 'rgb(255, 192, 203)')" id="btn-pink">🩷</button>
        <button onclick="toggleColor('gold', 'rgb(255, 215, 0)')" id="btn-gold">🟡</button>
        <button onclick="deleteSelectedFoldBlock()">刪除選取的折疊區</button>
      </div>
    </div>
    <div id="note" class="note-area" contenteditable="true"></div>
  </div>
  <script>
    const note = document.getElementById("note");

    function toggleFormat(command) {
      document.execCommand(command);
      note.focus();
      updateToolbarState();
    }

    function toggleCustomFormat(type) {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;

      const range = sel.getRangeAt(0);
      const selectedText = range.toString();
      const container = range.commonAncestorContainer;
      const parent = container.nodeType === 1 ? container : container.parentElement;
      if (!parent) return;

      const style = window.getComputedStyle(parent);
      const hasUnderline = style.textDecorationLine.includes("underline");
      const hasStrike = style.textDecorationLine.includes("line-through");

      const shouldRemove =
        (type === "underline" && hasUnderline) ||
        (type === "strike" && hasStrike);

      if (shouldRemove) {
        parent.style.textDecoration = "none";
        parent.style.textDecorationColor = "";
        updateToolbarState();
        return;
      }

      const span = document.createElement("span");
      span.textContent = selectedText || "\u200B";
      if (type === "underline") {
        span.style.textDecoration = "underline";
        span.style.textDecorationColor = "green";
        span.style.color = "black";
      } else if (type === "strike") {
        span.style.textDecoration = "line-through";
        span.style.textDecorationColor = "red";
        span.style.color = "black";
      }

      range.deleteContents();
      range.insertNode(span);
      const after = document.createTextNode("\u200B");
      span.after(after);
      range.setStart(after, 1);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);

      note.focus();
      updateToolbarState();
    }

    function toggleColor(colorName, rgbValue) {
      const current = getColorState();
      if (current === rgbValue) {
        document.execCommand("foreColor", false, "black");
      } else {
        document.execCommand("foreColor", false, colorName);
      }
      note.focus();
      updateToolbarState();
    }

    function getColorState() {
      const sel = window.getSelection();
      if (!sel.rangeCount) return "";
      const node = sel.anchorNode?.parentElement;
      if (!node) return "";
      return window.getComputedStyle(node).color.toLowerCase();
    }

    function hasDecoration(type) {
      const sel = window.getSelection();
      if (!sel.rangeCount) return false;
      const node = sel.anchorNode?.parentElement;
      if (!node) return false;
      const style = window.getComputedStyle(node);
      return style.textDecorationLine.includes(type);
    }

    function insertFold() {
      const details = document.createElement("details");
      details.className = "fold-block";
      const summary = document.createElement("summary");
      summary.textContent = "折疊區塊";
      details.appendChild(summary);
      details.appendChild(document.createTextNode("內容..."));
      note.appendChild(details);

      const range = document.createRange();
      range.selectNodeContents(details);
      range.collapse(false);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      note.focus();
    }

    function deleteSelectedFoldBlock() {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;

      const range = sel.getRangeAt(0);
      const container = range.commonAncestorContainer;
      const fold = container.nodeType === 1
        ? container.closest(".fold-block")
        : container.parentElement?.closest(".fold-block");

      if (fold) {
        fold.remove();
        sel.removeAllRanges();
        note.focus();
      }
    }

    function updateToolbarState() {
      const commands = {
        bold: "btn-bold",
        italic: "btn-italic"
      };
      for (const cmd in commands) {
        const btn = document.getElementById(commands[cmd]);
        if (document.queryCommandState(cmd)) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      }

      document.getElementById("btn-underline").classList.toggle("active", hasDecoration("underline"));
      document.getElementById("btn-strike").classList.toggle("active", hasDecoration("line-through"));

      const colorState = getColorState();
      const colorMap = {
        "rgb(255, 0, 0)": "btn-red",
        "rgb(255, 192, 203)": "btn-pink",
        "rgb(255, 215, 0)": "btn-gold"
      };
      for (const rgb in colorMap) {
        const btn = document.getElementById(colorMap[rgb]);
        if (colorState === rgb) {
          btn.classList.add("active");
        } else {
          btn.classList.remove("active");
        }
      }
    }

    note.addEventListener("input", () => {
      localStorage.setItem("dictation-note", note.innerHTML);
    });

    window.addEventListener("load", () => {
      const saved = localStorage.getItem("dictation-note");
      if (saved) note.innerHTML = saved;
    });

    document.addEventListener("selectionchange", updateToolbarState);




  </script>
</body>
</html>
